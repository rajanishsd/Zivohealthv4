graph TD
    %% OpenTelemetry Monitoring
    RequestStart[ðŸ”„ Request Begins] --> InitTrace[ðŸ” Initialize Trace]
    InitTrace --> AgentSpans[ðŸ“Š Create Agent Operation Spans]
    
    AgentSpans --> VitalsSpan[ðŸ’“ Vitals Agent Span]
    AgentSpans --> PharmacySpan[ðŸ’Š Pharmacy Agent Span]
    AgentSpans --> LabSpan[ðŸ§ª Lab Agent Span]
    AgentSpans --> PrescriptionSpan[ðŸ“ Prescription Agent Span]
    
    VitalsSpan --> VitalsOps[ðŸ’“ Vitals Operations]
    PharmacySpan --> PharmacyOps[ðŸ’Š Pharmacy Operations]
    LabSpan --> LabOps[ðŸ§ª Lab Operations]
    PrescriptionSpan --> PrescriptionOps[ðŸ“ Prescription Operations]
    
    VitalsOps --> DatabaseSpans[ðŸ—„ï¸ Database Operation Spans]
    PharmacyOps --> DatabaseSpans
    LabOps --> DatabaseSpans
    PrescriptionOps --> DatabaseSpans
    
    DatabaseSpans --> DBOperations[ðŸ’¾ Database Operations]
    DBOperations --> StoreTrace[ðŸ“Š Store Trace Data]
    StoreTrace --> TraceAnalysis[ðŸ“ˆ Trace Analysis]
    
    %% Error Handling
    ErrorTrigger[âš ï¸ Error Triggered] --> ClassifyError{ðŸ” Classify Error Type}
    
    ClassifyError -->|OCR Failure| OCRError[ðŸ“· OCR Processing Error]
    ClassifyError -->|LLM Failure| LLMError[ðŸ§  LLM Processing Error]
    ClassifyError -->|Database Failure| DBError[ðŸ—„ï¸ Database Error]
    ClassifyError -->|Agent Failure| AgentError[ðŸ¤– Agent Processing Error]
    
    OCRError --> OCRRecovery[ðŸ”„ OCR Recovery]
    LLMError --> LLMRecovery[ðŸ”„ LLM Recovery]
    DBError --> DBRecovery[ðŸ”„ Database Recovery]
    AgentError --> AgentRecovery[ðŸ”„ Agent Recovery]
    
    OCRRecovery --> RecoveryCheck{âœ… Recovery Successful?}
    LLMRecovery --> RecoveryCheck
    DBRecovery --> RecoveryCheck
    AgentRecovery --> RecoveryCheck
    
    RecoveryCheck -->|Yes| ContinueNormal[ðŸ”„ Continue Normal Processing]
    RecoveryCheck -->|No| GracefulDegradation[âš ï¸ Graceful Degradation]
    
    ContinueNormal --> LogSuccess[ðŸ“ Log Recovery Success]
    GracefulDegradation --> LogFailure[ðŸ“ Log Graceful Failure]
    
    LogSuccess --> UpdateMetrics[ðŸ“Š Update Success Metrics]
    LogFailure --> UpdateMetrics
    UpdateMetrics --> Alerting[ðŸš¨ Intelligent Alerting]
    
    %% Workflow Coordination
    WorkflowStart[ðŸŽ¬ Workflow Orchestration Begins] --> CustomerWorkflow[ðŸŽ¯ Customer Agent Workflow]
    CustomerWorkflow --> ParallelProcessing{ðŸ”„ Parallel Processing Needed?}
    
    ParallelProcessing -->|Yes| ParallelCoordinator[âš¡ Parallel Coordinator]
    ParallelProcessing -->|No| SequentialProcessing[ðŸ“ Sequential Processing]
    
    ParallelCoordinator --> StatSync[ðŸ”„ State Synchronization]
    SequentialProcessing --> StatSync
    
    StatSync --> WorkflowComplete[âœ… Workflow Completion]
    WorkflowComplete --> FinalValidation[ðŸ” Final Validation]
    FinalValidation --> DeliveryReady[ðŸ“¦ Ready for Delivery]
    DeliveryReady --> UserDelivery[ðŸ“± Deliver to User]
    
    %% Styling
    classDef monitoringClass fill:#e3f2fd
    classDef errorClass fill:#ffebee
    classDef workflowClass fill:#e8f5e8
    classDef recoveryClass fill:#fff3e0
    classDef successClass fill:#f1f8e9
    
    class RequestStart,InitTrace,AgentSpans,TraceAnalysis monitoringClass
    class ErrorTrigger,ClassifyError,OCRError,LLMError,DBError,AgentError errorClass
    class WorkflowStart,CustomerWorkflow,ParallelCoordinator,StatSync,WorkflowComplete workflowClass
    class OCRRecovery,LLMRecovery,DBRecovery,AgentRecovery,RecoveryCheck recoveryClass
    class ContinueNormal,LogSuccess,UpdateMetrics,DeliveryReady,UserDelivery successClass 